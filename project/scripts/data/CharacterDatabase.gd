# CharacterDatabase.gd
# Base de datos de todos los personajes jugables
# Cada personaje tiene stats únicos y un arma inicial diferente

extends Node
class_name CharacterDatabase

# ???????????????????????????????????????????????????????????????????????????????
# CONSTANTES
# ???????????????????????????????????????????????????????????????????????????????

# Estados de desbloqueo
enum UnlockStatus {
	LOCKED,           # Bloqueado, no disponible
	UNLOCKED,         # Desbloqueado y jugable
	STARTER           # Disponible desde el inicio
}

# Elementos (coincide con WeaponDatabase.Element)
enum Element {
	ICE,
	FIRE,
	LIGHTNING,
	ARCANE,
	SHADOW,
	NATURE,
	WIND,
	EARTH,
	LIGHT,
	VOID
}

# ???????????????????????????????????????????????????????????????????????????????
# BASE DE DATOS DE PERSONAJES (10 personajes)
# ???????????????????????????????????????????????????????????????????????????????

const CHARACTERS: Dictionary = {
	# ?????????????????????????????????????????????????????????????????????????????
	# FROST MAGE - Mago de Hielo (STARTER)
	# Control y ralentización de enemigos
	# ?????????????????????????????????????????????????????????????????????????????
	"frost_mage": {
		"id": "frost_mage",
		"name": "Frost Mage",
		"name_es": "Mago de Hielo",
		"title": "The Frozen One",
		"title_es": "El Congelado",
		"description": "A wise wizard who harnesses the power of ice to slow and freeze enemies.",
		"description_es": "Un sabio mago que controla el poder del hielo para ralentizar y congelar enemigos.",

		# Elemento y arma inicial
		"element": Element.ICE,
		"starting_weapon": "ice_wand",

		# Stats base (equilibrado)
		"stats": {
			"max_health": 100,
			"health_regen": 0.0,
			"move_speed": 200.0,
			"armor": 0,
			"damage_mult": 1.0,
			"cooldown_mult": 1.0,
			"area_mult": 1.0,
			"pickup_range": 50.0,
			"luck": 0.0,
			"xp_mult": 1.0
		},

		# Pasiva única
		"passive": {
			"id": "frozen_aura",
			"name": "Frozen Aura",
			"name_es": "Aura Gélida",
			"description": "Enemies near you are slowed by 10%",
			"description_es": "Los enemigos cercanos son ralentizados un 10%"
		},

		# Desbloqueo
		"unlock_status": UnlockStatus.STARTER,
		"unlock_requirement": null,

		# Visual
		"color_primary": Color(0.4, 0.8, 1.0),      # Azul hielo
		"color_secondary": Color(0.3, 0.6, 0.9),    # Azul profundo
		"icon": "??",
		"sprite_folder": "wizard",  # Usa los sprites actuales del wizard
		"portrait": "res://assets/sprites/players/portraits/frost_mage.png"
	},

	# ?????????????????????????????????????????????????????????????????????????????
	# PYROMANCER - Mago de Fuego (STARTER)
	# Alto daño, quema enemigos
	# ?????????????????????????????????????????????????????????????????????????????
	"pyromancer": {
		"id": "pyromancer",
		"name": "Pyromancer",
		"name_es": "Piromante",
		"title": "The Flame Bringer",
		"title_es": "El Portador de Llamas",
		"description": "A fierce mage who wields devastating fire magic, burning all in his path.",
		"description_es": "Un mago feroz que empuña magia de fuego devastadora, quemando todo a su paso.",

		"element": Element.FIRE,
		"starting_weapon": "fire_wand",

		# Stats (alto daño, menos vida)
		"stats": {
			"max_health": 90,
			"health_regen": 0.0,
			"move_speed": 210.0,
			"armor": 0,
			"damage_mult": 1.15,  # +15% daño
			"cooldown_mult": 1.0,
			"area_mult": 1.1,     # +10% área (explosiones)
			"pickup_range": 50.0,
			"luck": 0.0,
			"xp_mult": 1.0
		},

		"passive": {
			"id": "burning_soul",
			"name": "Burning Soul",
			"name_es": "Alma Ardiente",
			"description": "Fire damage burns 20% longer",
			"description_es": "El daño de fuego quema un 20% más de tiempo"
		},

		"unlock_status": UnlockStatus.STARTER,
		"unlock_requirement": null,

		"color_primary": Color(1.0, 0.4, 0.1),      # Naranja fuego
		"color_secondary": Color(1.0, 0.2, 0.0),    # Rojo intenso
		"icon": "??",
		"sprite_folder": "pyromancer",
		"portrait": "res://assets/sprites/players/portraits/pyromancer.png"
	},

	# ?????????????????????????????????????????????????????????????????????????????
	# STORM CALLER - Mago de Rayos (STARTER)
	# Rápido, daño en cadena
	# ?????????????????????????????????????????????????????????????????????????????
	"storm_caller": {
		"id": "storm_caller",
		"name": "Storm Caller",
		"name_es": "Invocador de Tormentas",
		"title": "The Thunder Born",
		"title_es": "El Nacido del Trueno",
		"description": "A swift mage who commands lightning, striking multiple foes at once.",
		"description_es": "Un mago veloz que controla el rayo, golpeando múltiples enemigos a la vez.",

		"element": Element.LIGHTNING,
		"starting_weapon": "lightning_wand",

		# Stats (rápido, menos vida)
		"stats": {
			"max_health": 85,
			"health_regen": 0.0,
			"move_speed": 230.0,  # Muy rápido
			"armor": 0,
			"damage_mult": 1.0,
			"cooldown_mult": 0.95,  # -5% cooldown
			"area_mult": 1.0,
			"pickup_range": 55.0,
			"luck": 0.05,  # +5% suerte (críticos)
			"xp_mult": 1.0
		},

		"passive": {
			"id": "static_charge",
			"name": "Static Charge",
			"name_es": "Carga Estática",
			"description": "Lightning chains to 1 additional enemy",
			"description_es": "Los rayos saltan a 1 enemigo adicional"
		},

		"unlock_status": UnlockStatus.STARTER,
		"unlock_requirement": null,

		"color_primary": Color(1.0, 1.0, 0.3),      # Amarillo eléctrico
		"color_secondary": Color(0.6, 0.4, 1.0),    # Púrpura tormenta
		"icon": "?",
		"sprite_folder": "storm_caller",
		"portrait": "res://assets/sprites/players/portraits/storm_caller.png"
	},

	# ?????????????????????????????????????????????????????????????????????????????
	# ARCANIST - Mago Arcano (UNLOCKABLE)
	# Defensivo, orbitales
	# ?????????????????????????????????????????????????????????????????????????????
	"arcanist": {
		"id": "arcanist",
		"name": "Arcanist",
		"name_es": "Arcanista",
		"title": "The Mystic Scholar",
		"title_es": "El Erudito Místico",
		"description": "A defensive mage surrounded by arcane orbs that protect and damage.",
		"description_es": "Un mago defensivo rodeado de orbes arcanos que protegen y dañan.",

		"element": Element.ARCANE,
		"starting_weapon": "arcane_orb",

		# Stats (defensivo, lento)
		"stats": {
			"max_health": 110,
			"health_regen": 0.5,  # Regeneración leve
			"move_speed": 180.0,
			"armor": 5,  # Algo de armadura
			"damage_mult": 0.95,
			"cooldown_mult": 1.0,
			"area_mult": 1.15,  # +15% área orbital
			"pickup_range": 60.0,
			"luck": 0.0,
			"xp_mult": 1.0
		},

		"passive": {
			"id": "arcane_shield",
			"name": "Arcane Shield",
			"name_es": "Escudo Arcano",
			"description": "Start with +1 orbital projectile",
			"description_es": "Comienza con +1 proyectil orbital"
		},

		"unlock_status": UnlockStatus.LOCKED,
		"unlock_requirement": {
			"type": "total_runs",
			"value": 10,
			"description": "Complete 10 runs",
			"description_es": "Completa 10 partidas"
		},

		"color_primary": Color(0.7, 0.3, 1.0),      # Púrpura arcano
		"color_secondary": Color(0.5, 0.2, 0.8),    # Púrpura oscuro
		"icon": "??",
		"sprite_folder": "arcanist",
		"portrait": "res://assets/sprites/players/portraits/arcanist.png"
	},

	# ?????????????????????????????????????????????????????????????????????????????
	# SHADOW BLADE - Asesino de Sombras (UNLOCKABLE)
	# Muy rápido, muy frágil
	# ?????????????????????????????????????????????????????????????????????????????
	"shadow_blade": {
		"id": "shadow_blade",
		"name": "Shadow Blade",
		"name_es": "Hoja Sombría",
		"title": "The Phantom",
		"title_es": "El Fantasma",
		"description": "A deadly assassin who strikes from the shadows with piercing daggers.",
		"description_es": "Un asesino letal que golpea desde las sombras con dagas perforantes.",

		"element": Element.SHADOW,
		"starting_weapon": "shadow_dagger",

		# Stats (glass cannon extremo)
		"stats": {
			"max_health": 70,  # Muy frágil
			"health_regen": 0.0,
			"move_speed": 250.0,  # Muy rápido
			"armor": 0,
			"damage_mult": 1.2,  # +20% daño
			"cooldown_mult": 0.9,  # -10% cooldown
			"area_mult": 0.9,
			"pickup_range": 45.0,
			"luck": 0.1,  # +10% suerte (críticos)
			"xp_mult": 1.0
		},

		"passive": {
			"id": "shadow_step",
			"name": "Shadow Step",
			"name_es": "Paso Umbrío",
			"description": "+1 pierce on all projectiles",
			"description_es": "+1 penetración en todos los proyectiles"
		},

		"unlock_status": UnlockStatus.LOCKED,
		"unlock_requirement": {
			"type": "kills_total",
			"value": 5000,
			"description": "Defeat 5000 enemies total",
			"description_es": "Derrota 5000 enemigos en total"
		},

		"color_primary": Color(0.3, 0.1, 0.4),      # Púrpura oscuro
		"color_secondary": Color(0.1, 0.05, 0.15),  # Negro
		"icon": "???",
		"sprite_folder": "shadow_blade",
		"portrait": "res://assets/sprites/players/portraits/shadow_blade.png"
	},

	# ?????????????????????????????????????????????????????????????????????????????
	# DRUID - Druida de Naturaleza (UNLOCKABLE)
	# Regeneración, equilibrado
	# ?????????????????????????????????????????????????????????????????????????????
	"druid": {
		"id": "druid",
		"name": "Druid",
		"name_es": "Druida",
		"title": "The Nature Guardian",
		"title_es": "El Guardián de la Naturaleza",
		"description": "A peaceful guardian who heals through nature and uses homing magic.",
		"description_es": "Un guardián pacífico que sana mediante la naturaleza y usa magia rastreadora.",

		"element": Element.NATURE,
		"starting_weapon": "nature_staff",

		# Stats (regeneración y equilibrio)
		"stats": {
			"max_health": 100,
			"health_regen": 1.5,  # Regeneración alta
			"move_speed": 190.0,
			"armor": 0,
			"damage_mult": 0.95,
			"cooldown_mult": 1.0,
			"area_mult": 1.0,
			"pickup_range": 70.0,  # Mayor rango de recogida
			"luck": 0.0,
			"xp_mult": 1.1  # +10% XP
		},

		"passive": {
			"id": "natures_blessing",
			"name": "Nature's Blessing",
			"name_es": "Bendición Natural",
			"description": "Heal 1 HP when collecting experience",
			"description_es": "Cura 1 PV al recoger experiencia"
		},

		"unlock_status": UnlockStatus.LOCKED,
		"unlock_requirement": {
			"type": "survive_time",
			"value": 900,  # 15 minutos
			"description": "Survive for 15 minutes in a single run",
			"description_es": "Sobrevive 15 minutos en una sola partida"
		},

		"color_primary": Color(0.3, 0.8, 0.2),      # Verde naturaleza
		"color_secondary": Color(0.2, 0.5, 0.1),    # Verde oscuro
		"icon": "??",
		"sprite_folder": "druid",
		"portrait": "res://assets/sprites/players/portraits/druid.png"
	},

	# ?????????????????????????????????????????????????????????????????????????????
	# WIND RUNNER - Corredor del Viento (UNLOCKABLE)
	# Extremadamente rápido
	# ?????????????????????????????????????????????????????????????????????????????
	"wind_runner": {
		"id": "wind_runner",
		"name": "Wind Runner",
		"name_es": "Corredor del Viento",
		"title": "The Swift",
		"title_es": "El Veloz",
		"description": "The fastest mage, using wind magic to outrun any danger.",
		"description_es": "El mago más rápido, usando magia de viento para escapar de cualquier peligro.",

		"element": Element.WIND,
		"starting_weapon": "wind_blade",

		# Stats (velocidad extrema)
		"stats": {
			"max_health": 80,
			"health_regen": 0.0,
			"move_speed": 270.0,  # El más rápido
			"armor": 0,
			"damage_mult": 0.9,   # Menos daño
			"cooldown_mult": 0.95,
			"area_mult": 1.0,
			"pickup_range": 80.0,  # Gran rango
			"luck": 0.0,
			"xp_mult": 1.0
		},

		"passive": {
			"id": "tailwind",
			"name": "Tailwind",
			"name_es": "Viento de Cola",
			"description": "Move 15% faster when below 50% HP",
			"description_es": "Muévete 15% más rápido bajo 50% de vida"
		},

		"unlock_status": UnlockStatus.LOCKED,
		"unlock_requirement": {
			"type": "level_reached",
			"value": 30,
			"description": "Reach level 30 in a single run",
			"description_es": "Alcanza nivel 30 en una sola partida"
		},

		"color_primary": Color(0.8, 0.95, 0.9),     # Blanco verdoso
		"color_secondary": Color(0.6, 0.9, 0.85),   # Cian claro
		"icon": "???",
		"sprite_folder": "wind_runner",
		"portrait": "res://assets/sprites/players/portraits/wind_runner.png"
	},

	# ?????????????????????????????????????????????????????????????????????????????
	# GEOMANCER - Geomante de Tierra (UNLOCKABLE)
	# Tanque lento
	# ?????????????????????????????????????????????????????????????????????????????
	"geomancer": {
		"id": "geomancer",
		"name": "Geomancer",
		"name_es": "Geomante",
		"title": "The Mountain",
		"title_es": "La Montaña",
		"description": "An immovable tank who crushes enemies with devastating earth magic.",
		"description_es": "Un tanque inamovible que aplasta enemigos con magia de tierra devastadora.",

		"element": Element.EARTH,
		"starting_weapon": "earth_spike",

		# Stats (tanque extremo)
		"stats": {
			"max_health": 150,  # Muchísima vida
			"health_regen": 0.5,
			"move_speed": 155.0,  # Muy lento
			"armor": 15,  # Mucha armadura
			"damage_mult": 1.1,
			"cooldown_mult": 1.1,  # Ataques más lentos
			"area_mult": 1.2,
			"pickup_range": 40.0,  # Rango bajo
			"luck": 0.0,
			"xp_mult": 0.9  # -10% XP
		},

		"passive": {
			"id": "stone_skin",
			"name": "Stone Skin",
			"name_es": "Piel de Piedra",
			"description": "Take 20% less damage when standing still",
			"description_es": "Recibe 20% menos daño al estar quieto"
		},

		"unlock_status": UnlockStatus.LOCKED,
		"unlock_requirement": {
			"type": "damage_taken",
			"value": 10000,
			"description": "Take 10000 total damage across all runs",
			"description_es": "Recibe 10000 de daño total entre todas las partidas"
		},

		"color_primary": Color(0.6, 0.4, 0.2),      # Marrón tierra
		"color_secondary": Color(0.4, 0.3, 0.15),   # Marrón oscuro
		"icon": "??",
		"sprite_folder": "geomancer",
		"portrait": "res://assets/sprites/players/portraits/geomancer.png"
	},

	# ?????????????????????????????????????????????????????????????????????????????
	# PALADIN - Paladín de Luz (UNLOCKABLE)
	# Tanque equilibrado con críticos
	# ?????????????????????????????????????????????????????????????????????????????
	"paladin": {
		"id": "paladin",
		"name": "Paladin",
		"name_es": "Paladín",
		"title": "The Light Bringer",
		"title_es": "El Portador de Luz",
		"description": "A holy warrior who smites enemies with pure light and critical strikes.",
		"description_es": "Un guerrero sagrado que castiga enemigos con luz pura y golpes críticos.",

		"element": Element.LIGHT,
		"starting_weapon": "light_beam",

		# Stats (tanque con críticos)
		"stats": {
			"max_health": 120,
			"health_regen": 0.3,
			"move_speed": 180.0,
			"armor": 5,
			"damage_mult": 1.0,
			"cooldown_mult": 1.05,
			"area_mult": 0.9,
			"pickup_range": 50.0,
			"luck": 0.15,  # +15% suerte (críticos)
			"xp_mult": 1.0
		},

		"passive": {
			"id": "divine_judgment",
			"name": "Divine Judgment",
			"name_es": "Juicio Divino",
			"description": "Critical hits deal 50% more damage",
			"description_es": "Los críticos hacen 50% más de daño"
		},

		"unlock_status": UnlockStatus.LOCKED,
		"unlock_requirement": {
			"type": "bosses_defeated",
			"value": 10,
			"description": "Defeat 10 bosses",
			"description_es": "Derrota 10 jefes"
		},

		"color_primary": Color(1.0, 1.0, 0.9),      # Blanco dorado
		"color_secondary": Color(1.0, 0.9, 0.5),    # Dorado
		"icon": "?",
		"sprite_folder": "paladin",
		"portrait": "res://assets/sprites/players/portraits/paladin.png"
	},

	# ?????????????????????????????????????????????????????????????????????????????
	# VOID WALKER - Caminante del Vacío (UNLOCKABLE)
	# Alto riesgo/recompensa
	# ?????????????????????????????????????????????????????????????????????????????
	"void_walker": {
		"id": "void_walker",
		"name": "Void Walker",
		"name_es": "Caminante del Vacío",
		"title": "The Abyss Touched",
		"title_es": "El Tocado por el Abismo",
		"description": "A mysterious mage who traded his health for immense void power.",
		"description_es": "Un mago misterioso que cambió su salud por inmenso poder del vacío.",

		"element": Element.VOID,
		"starting_weapon": "void_pulse",

		# Stats (glass cannon con mecánicas especiales)
		"stats": {
			"max_health": 60,  # Muy frágil
			"health_regen": -0.5,  # PIERDE vida constantemente
			"move_speed": 200.0,
			"armor": 0,
			"damage_mult": 1.3,  # +30% daño
			"cooldown_mult": 0.85,  # -15% cooldown
			"area_mult": 1.25,
			"pickup_range": 100.0,  # Atrae pickups
			"luck": 0.0,
			"xp_mult": 1.2  # +20% XP
		},

		"passive": {
			"id": "void_hunger",
			"name": "Void Hunger",
			"name_es": "Hambre del Vacío",
			"description": "Killing enemies heals 2 HP, but lose 0.5 HP/sec",
			"description_es": "Matar enemigos cura 2 PV, pero pierdes 0.5 PV/seg"
		},

		"unlock_status": UnlockStatus.LOCKED,
		"unlock_requirement": {
			"type": "all_weapons_collected",
			"value": 1,  # Boolean-like
			"description": "Collect all 10 base weapons in a single run",
			"description_es": "Recoge las 10 armas base en una sola partida"
		},

		"color_primary": Color(0.2, 0.0, 0.3),      # Púrpura vacío
		"color_secondary": Color(0.1, 0.0, 0.2),    # Negro púrpura
		"icon": "??",
		"sprite_folder": "void_walker",
		"portrait": "res://assets/sprites/players/portraits/void_walker.png"
	}
}

# ???????????????????????????????????????????????????????????????????????????????
# FUNCIONES DE ACCESO
# ???????????????????????????????????????????????????????????????????????????????

static func get_character(character_id: String) -> Dictionary:
	"""Obtener datos de un personaje por su ID"""
	if CHARACTERS.has(character_id):
		return CHARACTERS[character_id].duplicate(true)
	push_error("[CharacterDatabase] Character not found: " + character_id)
	return {}

static func get_all_characters() -> Array:
	"""Obtener array con todos los personajes"""
	var result = []
	for char_id in CHARACTERS:
		result.append(CHARACTERS[char_id].duplicate(true))
	return result

static func get_starter_characters() -> Array:
	"""Obtener personajes disponibles desde el inicio"""
	var result = []
	for char_id in CHARACTERS:
		if CHARACTERS[char_id].unlock_status == UnlockStatus.STARTER:
			result.append(CHARACTERS[char_id].duplicate(true))
	return result

static func get_unlocked_characters(save_data: Dictionary = {}) -> Array:
	"""Obtener personajes desbloqueados (starter + unlocked)"""
	var result = []
	var unlocked_ids = save_data.get("unlocked_characters", [])

	for char_id in CHARACTERS:
		var char_data = CHARACTERS[char_id]
		if char_data.unlock_status == UnlockStatus.STARTER:
			result.append(char_data.duplicate(true))
		elif char_data.unlock_status == UnlockStatus.UNLOCKED:
			result.append(char_data.duplicate(true))
		elif char_id in unlocked_ids:
			var data = char_data.duplicate(true)
			data.unlock_status = UnlockStatus.UNLOCKED
			result.append(data)

	return result

static func get_character_ids() -> Array:
	"""Obtener array con todos los IDs de personajes"""
	return CHARACTERS.keys()

static func get_starting_weapon(character_id: String) -> String:
	"""Obtener el arma inicial de un personaje"""
	if CHARACTERS.has(character_id):
		return CHARACTERS[character_id].starting_weapon
	return "ice_wand"  # Default

static func get_character_stats(character_id: String) -> Dictionary:
	"""Obtener los stats base de un personaje"""
	if CHARACTERS.has(character_id):
		return CHARACTERS[character_id].stats.duplicate(true)
	# Stats por defecto
	return {
		"max_health": 100,
		"health_regen": 0.0,
		"move_speed": 200.0,
		"armor": 0,
		"damage_mult": 1.0,
		"cooldown_mult": 1.0,
		"area_mult": 1.0,
		"pickup_range": 50.0,
		"luck": 0.0,
		"xp_mult": 1.0
	}

static func check_unlock_requirement(character_id: String, player_stats: Dictionary) -> bool:
	"""Verificar si un personaje cumple los requisitos de desbloqueo"""
	if not CHARACTERS.has(character_id):
		return false

	var char_data = CHARACTERS[character_id]

	# Starters siempre disponibles
	if char_data.unlock_status == UnlockStatus.STARTER:
		return true

	var req = char_data.get("unlock_requirement")
	if not req:
		return false

	var req_type = req.get("type", "")
	var req_value = req.get("value", 0)

	match req_type:
		"total_runs":
			return player_stats.get("total_runs", 0) >= req_value
		"kills_total":
			return player_stats.get("enemies_defeated", 0) >= req_value
		"survive_time":
			return player_stats.get("best_time", 0) >= req_value
		"level_reached":
			return player_stats.get("best_level", 0) >= req_value
		"damage_taken":
			return player_stats.get("total_damage_taken", 0) >= req_value
		"bosses_defeated":
			return player_stats.get("bosses_defeated", 0) >= req_value
		"all_weapons_collected":
			return player_stats.get("max_weapons_in_run", 0) >= 10
		_:
			return false

# ???????????????????????????????????????????????????????????????????????????????
# DEBUG
# ???????????????????????????????????????????????????????????????????????????????

static func print_all_characters() -> void:
	"""Imprimir todos los personajes (debug)"""
	print("???????????????????????????????????????????????????")
	print("CHARACTER DATABASE - %d characters" % CHARACTERS.size())
	print("???????????????????????????????????????????????????")
	for char_id in CHARACTERS:
		var c = CHARACTERS[char_id]
		var status = "STARTER" if c.unlock_status == UnlockStatus.STARTER else "LOCKED"
		print("%s %s (%s) - %s - Weapon: %s" % [c.icon, c.name, status, c.element, c.starting_weapon])
	print("???????????????????????????????????????????????????")
